{% extends 'base.html' %}
{% block content %}
{% load static %}
<link rel="stylesheet" href="{% static 'styles/common.css' %}">
<link rel="stylesheet" href="{% static 'styles/ToastNotify.css' %}">
<script src="{% static 'javascript/ToastNotify.js' %}" defer></script>
<script src="{% static 'javascript/order_detail.js' %}" defer></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

<main class="container mt-4">
    {% if success %}
    <section class="row">
        {% if msg_secondary %}
            <section class="alert alert-danger" role="alert">{{msg_secondary}}</section>
        {% endif %}
        <section class="col-md-6">
            <!-- Información general -->
            <article class="card mb-3">
                <section class="card-header">
                    <h5 class="card-title text-center">Información general del pedido <span class="badge bg-primary">{{pedido.id}}</span></h5>
                </section>
                <section class="card-body">
                    <h5 class="card-title">Hora de venta: <span class="badge {{pedido.get_status_tiempo}}">{{pedido.fecha}}</span></h5>
                    <h5>Hora de completación: {% if pedido.completado_por %} <span class="badge bg-success">{{pedido.completado_hora}}</span>{% else %}Aún no se ha completado el pedido. {% endif %}</h5>
                    <p class="card-text">
                        Cliente: <strong>{{cliente}}</strong> <br>
                        Dirección de entrega: <strong>{{cliente.direccion}}</strong><br>
                        Vendedor: <strong>{{pedido.vendedor}}</strong>
                    </p>
                    <p class="card-text">Estado del pedido:
                        {% if pedido.estado_id == 5 %}
                            {% if not isAdmin %}
                                Cancelado
                            {% else %}
                                {{pedido.estado}} 
                            {% endif %}
                        {% else %}
                            {{pedido.estado}} 
                        {% endif %}
                         
                         <br>
                        {% if pedido.estado_id == 0 %}
                            Este pedido está a la espera de ser empacado.
                        {% elif pedido.estado_id == 1 %}
                            Este pedido está siendo empacado
                        {% elif pedido.estado_id == 2 %}
                            Este pedido está siendo facturado
                        {% elif pedido.estado_id == 3 %}
                            Este pedido está a la espera de que se le asigne un repartidor
                        {% elif pedido.estado_id == 4 %}
                            Este pedido salió a reparto
                        {% elif pedido.estado_id == 5 %}
                            {% if isAdmin %}
                                Este pedido está pendiente de pago
                            {% else %}
                                Este pedido ya fue entregado con éxito
                            {% endif %}
                        {% elif pedido.estado_id == 6 %}
                            Este pedido ya fue entregado con éxito
                        {% else %}
                            Descripción no disponible
                        {% endif %}
                    </p>
                    {% if pedido.nota %}
                        <h5>Nota de venta:</h5>
                        <p class="text-bold">{{pedido.nota}}</p>
                    {% else %}
                        <p class="text-bold">Este pedido no tiene nota de venta.</p>
                    {% endif %}
                </section>
            </article>
            <!-- Empaquetamietno-->
            <article class="card mb-3">
                <section class="card-header">
                    <h5 class="card-title text-center">Empaquetamiento</h5>
                </section>
                <section class="card-body">
                    {% if pedido.estado_id == 0 %}
                        <h5>Este pedido está a la espera de ser empacado.</h5>
                        {% if user.tipo_usuario_id == 3 or isAdmin %}
                            <!-- trigger -->
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modal">Empacar</button>
                            <!-- modal -->
                            <section class="modal fade" id="modal" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
                                <article class="modal-dialog modal-dialog-centered">
                                    <article class="modal-content">
                                        <section class="modal-header">
                                            <h5 class="modal-title">Confirmar empaque</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                        </section>
                                        <section class="modal-body">
                                            <p>¿Empacar este pedido?</p>
                                        </section>
                                        <section class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Salir</button>
                                            <form action="" method="POST">
                                                {% csrf_token %}
                                                <input type="hidden" name="confirmar_empaque">
                                                <button type="submit" class="btn btn-warning">Confirmar</button>
                                            </form>
                                        </section>
                                    </article>
                                </article>
                            </section>
                        {% endif %}
                    {% elif pedido.estado_id == 1 %}
                        <h5>Este pedido está siendo empacado por:</h5>
                        <ul class="list-group list-group-flush">
                            {% for e in empacadoresActivos %}
                            <li class="list-group-item">
                                <p>{{e.empacador.first_name}} {{e.empacador.last_name}} <br>
                                    Cod. empleado {{e.empacador.id}}
                                </p>
                            </li>
                            {% endfor %}          
                        </ul>
                        <article class="mb-4">
                            {% if pedido.get_multiple_bodega %}
                                <strong>Este pedido necesita la aprobación de las 2 bodegas.</strong> <br>
                                {% if pedido.check_bodega %}
                                    Este pedido ya fue completado por una de las 2 bodegas. <br>
                                    Ya fue completado por: {{pedido.checkeado_por}}
                                {% endif %}
                            {% endif %}
                            <span class="badge bg-danger text-wrap mx-4 my-2">{{issue}}</span>
                        </article> 
                        {% for e in empacadoresActivos %}
                            {% if user.id == e.empacador.id %}
                            <button class="btn btn-success" data-bs-toggle="modal" {% if pedido.checkeado_por == user %} disabled {% endif %} data-bs-target="#modalC">Marcar como completo</button>
                            <!-- modal -->
                            <section class="modal fade" id="modalC" tabindex="-1" aria-labelledby="modalHLabel" aria-hidden="true">
                                <article class="modal-dialog modal-dialog-centered">
                                    <article class="modal-content">
                                        <section class="modal-header">
                                            <h5 class="modal-title">Confirmar marcar como completo</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                        </section>
                                        <section class="modal-body">
                                            <p>¿Este pedido ya está empacado?</p>
                                        </section>
                                        <section class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Salir</button>
                                            <form action="" method="POST" id="empaqueForm">
                                                {% csrf_token %}
                                                <input type="hidden" name="completarEmpaque">
                                                <button type="submit" class="btn btn-success">Sí, está empacado</button>
                                            </form>
                                        </section>
                                    </article>
                                </article>
                            </section>
                            {% endif %}
                        {% endfor %}
                        {% if puede_ayudar %}
                            <button class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#modalH">Ayudar a empacar</button>
                            <!-- modal -->
                            <section class="modal fade" id="modalH" tabindex="-1" aria-labelledby="modalHLabel" aria-hidden="true">
                                <article class="modal-dialog modal-dialog-centered">
                                    <article class="modal-content">
                                        <section class="modal-header">
                                            <h5 class="modal-title">Confirmar ayudar a empacar</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                        </section>
                                        <section class="modal-body">
                                            <p>¿Realmente quiere ayudar a empacar este pedido?</p>
                                        </section>
                                        <section class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Salir</button>
                                            <form action="" method="POST">
                                                {% csrf_token %}
                                                <input type="hidden" name="ayudar_a_empacar">
                                                <button type="submit" class="btn btn-warning">Ayudar a empacar</button>
                                            </form>
                                        </section>
                                    </article>
                                </article>
                            </section>
                        {% endif %}
                    {% elif pedido.estado_id > 1 %}
                        <h5>Este pedido fue empacado por:</h5>
                        <ul class="list-group list-group-flush">
                            {% for e in empacadoresActivos %}
                            <li class="list-group-item">
                                <p>{{e.empacador.first_name}} {{e.empacador.last_name}} <br>
                                Cod. empleado {{e.empacador.id}}</p>
                            </li>
                            {% endfor %}          
                        </ul>
                        <p>Hora empacado: <span class="badge bg-info">{% if pedido.empacado_hora %} {{pedido.empacado_hora}} {% else %} No se pudo recuperar la hora de empaquetamiento {% endif %}</span>
                        </p>
                        <span class="badge bg-danger">{{issue3}}</span>
                    {% endif %}
                    {% if pedido.notaEmpacador %}
                        <h5 class="mt-3">Nota del empacador</h5>
                        <p>{{pedido.notaEmpacador}}</p>
                    {% endif %}
                </section>
            </article>
            <!-- Facturacion -->
            <section class="card mb-3">
                <article class="card-header text-center">
                    <h5>Facturación</h5>
                </article>
                <article class="card-body">
                    {% if pedido.estado.id < 2 %}
                        <h5>Este pedido aún no puede ser facturado</h5>
                    {% elif pedido.estado.id == 2 %}
                        <h5>Este pedido está listo para ser facturado</h5>
                        {% if user.tipo_usuario_id == 4 or isAdmin %}
                            <!-- trigger -->
                            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#modalFacturacion">Facturación lista</button>
                            <!-- modal -->
                            <section class="modal fade" id="modalFacturacion" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
                                <article class="modal-dialog modal-dialog-centered">
                                    <article class="modal-content">
                                        <section class="modal-header">
                                            <h5 class="modal-title">Confirmar facturacion y repartidor</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                        </section>
                                        <section class="modal-body">
                                            <p>Antes de continuar asegurese de haber facturado completamente el pedido.</p>
                                        </section>
                                        <section class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Salir</button>
                                            <form action="" method="POST">
                                                {% csrf_token %}
                                                <input type="hidden" name="confirmarFacturacion">   
                                                <button type="submit" class="btn btn-warning">Confirmar facturacion</button>                             
                                            </form>
                                        </section>
                                    </article>
                                </article>
                            </section>
                        {% endif %}
                    {% else %}
                    <h5>Este pedido fue facturado por </h5>
                    <p>
                        {{pedido.facturado_por}} <br>
                        Hora de facturación: <span class="badge bg-info">{{pedido.facturado_hora}}</span>
                    </p>
                    <span class="badge bg-danger">{{issue4}}</span>
                    {% endif %}
                </article>
            </section>
            <!-- Despacho -->
            <section class="card mb-3">
                <article class="card-header text-center">
                    <h5>Reparto</h5>
                </article>
                <article class="card-body">
                    {% if pedido.estado.id < 3 %}
                        <h5>Este pedido aún no puede ser repartido</h5>
                    {% elif pedido.estado.id == 3 %}
                        <h5>Este pedido está listo para ser repartido</h5>
                        {% if user.tipo_usuario_id == 5 or isAdmin %}
                            <!-- trigger -->
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalAsignador">Gestionar despacho</button>
                            <!-- modal -->
                            <section class="modal fade" id="modalAsignador" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
                                <article class="modal-dialog modal-dialog-centered">
                                    <article class="modal-content">
                                        <section class="modal-header">
                                            <h5 class="modal-title">Seleccionar repartidor</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                        </section>
                                        <section class="modal-body">
                                            <form action="" method="POST" id="confirmarRepartidor" class="text-end ">
                                                {% csrf_token %}
                                                <fieldset class="text-start mb-2">
                                                    <strong>{{form.repartidor.label}}</strong>
                                                    {{form.repartidor}}
                                                </fieldset>
                                                <fieldset class="text-start mb-2">
                                                    <strong>{{form.repartidorSecundario.label}}</strong>
                                                    {{form.repartidorSecundario}}
                                                </fieldset>
                                                <fieldset class="text-start mb-2">
                                                    <strong>{{form.consecutivo.label}}</strong>
                                                    {{form.consecutivo}}
                                                </fieldset>
                                                <fieldset class="text-start mb-2">
                                                    <strong>{{form.tipo_consecutivo.label}}</strong>
                                                    {{form.tipo_consecutivo}}
                                                </fieldset>
                                                <input type="hidden" name="confirmarRepartidor" id="confirmarRepartidorInput">
                                                <input type="hidden" name="pendienteRepartidor" id="marcarPendienteInput">
                                                <button type="submit" class="btn btn-warning mt-3 text-white" onclick="setAction('pendiente')"> Marcar como pendiente</button>
                                                <button type="submit" class="btn btn-success mt-3 text-white" onclick="setAction('confirmarDespacho')">Confirmar despacho</button>                             
                                            </form> 
                                        </section>
                                        <section class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Salir</button>
                                        </section>
                                    </article>
                                </article>
                            </section>
                        {% endif %}
                    {% elif pedido.estado.id == 5 or pedido.estado.id == 4 %}
                        {% if pedido.estado.id == 4 %}
                            <h5>Este pedido está pendiente</h5>
                        {% elif pedido.estado.id == 5 %}
                            <h5>Este pedido está siendo repartido</h5>
                        {% endif %}
                        <h6>Consecutivo: {%if pedido.consecutivo %} <span class="badge bg-info">{{pedido.consecutivo}} </span> {% else %} Sin consecutivo {% endif %}</h6>
                        <h6>Tipo de consecutivo: {% if pedido.tipo_consecutivo %} <span class="badge bg-info">{{pedido.tipo_consecutivo}}</span> {% else %} Sin tipo de consecutivo {% endif %}</h6>
                        <p>Despachador: {{pedido.completado_por}} <br>
                        Hora de despacho - <span class="badge bg-info">{{pedido.completado_hora}}</span><br>
                        {% if pedido.despacho_modificado_hora %}
                            Este pedido fue modificado - <span class="badge bg-warning">{{pedido.despacho_modificado_hora}}</span>
                        {% endif %}
                        </p>
                        <h5>Repartidor(es) elegido(s)</h5>
                        <ul class="list-group list-group-flush">
                            {% for r in repartidoresActivos %}
                            <li class="list-group-item">
                                <p>{{r.repartidor.first_name}} {{r.repartidor.last_name}}
                                    Cod. Empleado {{r.repartidor.id}}
                                </p>
                            </li>
                            {% endfor %}
                        </ul>
                        {% if user.tipo_usuario_id == 5 or isAdmin %}
                            <!-- trigger -->
                            <button class="btn btn-warning text-white" data-bs-toggle="modal" data-bs-target="#modalDespachadorModificar">Modificar repartidor</button>
                            <!-- modal -->
                            <section class="modal fade" id="modalDespachadorModificar" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
                                <article class="modal-dialog modal-dialog-centered">
                                    <article class="modal-content">
                                        <section class="modal-header">
                                            <h5 class="modal-title">Modificar repartidor</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                        </section>
                                        <section class="modal-body">
                                            <p>Modificar al repartidor</p>
                                            <form action="" method="POST" class="text-end">
                                                {% csrf_token %}
                                                <fieldset class="text-start mb-2">
                                                    <strong>Modificar repartidor principal</strong>
                                                    {{form.repartidor}}
                                                </fieldset>
                                                <fieldset class="text-start">
                                                    <strong>Modificar repartidor secundario</strong>
                                                    {{form.repartidorSecundario}}
                                                </fieldset>
                                                <fieldset class="text-start mb-2">
                                                    <strong>Consecutivo: </strong>
                                                    {{form.consecutivo}}
                                                </fieldset>
                                                <fieldset class="text-start mb-2">
                                                    <strong>Tipo consecutivo </strong>
                                                    {{form.tipo_consecutivo}}
                                                </fieldset>
                                                <input type="hidden" name="modificarRepartidor">
                                                <button type="submit" class="btn btn-warning mt-3 text-white">Guardar modificacion</button>             
                                            </form>   
                                        </section>
                                        <section class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Salir</button>
                                        </section>
                                    </article>
                                </article>
                            </section>
                            {% if pedido.estado_id == 4 %}
                            <!-- Trigger -->
                            <button class="btn btn-primary text-white" data-bs-toggle="modal" data-bs-target="#modalMarcarDespachado">Marcar como despachado</button>
                            <!-- modal -->
                            <section class="modal fade" id="modalMarcarDespachado" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
                                <article class="modal-dialog modal-dialog-centered">
                                    <article class="modal-content">
                                        <section class="modal-header">
                                            <h5 class="modal-title">Marcar como despachado</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                        </section>
                                        <section class="modal-body">
                                            <p>Modifica y confirma los datos</p>
                                            <form action="" method="POST" class="text-end">
                                                {% csrf_token %}
                                                <fieldset class="text-start mb-2">
                                                    <strong>Modificar repartidor principal</strong>
                                                    {{form.repartidor}}
                                                </fieldset>
                                                <fieldset class="text-start">
                                                    <strong>Modificar repartidor secundario</strong>
                                                    {{form.repartidorSecundario}}
                                                </fieldset>
                                                <fieldset class="text-start mb-2">
                                                    <strong>Consecutivo: </strong>
                                                    {{form.consecutivo}}
                                                </fieldset>
                                                <fieldset class="text-start mb-2">
                                                    <strong>Tipo consecutivo </strong>
                                                    {{form.tipo_consecutivo}}
                                                </fieldset>
                                                <input type="hidden" name="confirmarRepartidor" value="true">
                                                <button type="submit" class="btn btn-success mt-3 text-white">Marcar como despachado</button>
                                            </form> 
            
                                        </section>
                                        <section class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Salir</button>
                                        </section>
                                    </article>
                                </article>
                            </section>
                            {% endif %}
                        {% endif %} 
                        <br>
                        <span class="badge bg-danger">{{issue5}}</span>
                    {% else %}
                    <h5>Este pedido fue repartido por:</h5>
                    <h6>Consecutivo: {%if pedido.consecutivo %} <span class="badge bg-info">{{pedido.consecutivo}} </span> {% else %} Sin consecutivo {% endif %}</h6>
                    <h6>Tipo de consecutivo: {% if pedido.tipo_consecutivo %} <span class="badge bg-info">{{pedido.tipo_consecutivo}}</span> {% else %} Sin tipo de consecutivo {% endif %}</h6>
                    <p>Despachador: {{pedido.completado_por}} <br>
                    Hora de despacho - <span class="badge bg-info">{{pedido.completado_hora}}</span><br>
                    {% if pedido.despacho_modificado_hora %}
                        Este pedido fue modificado - <span class="badge bg-warning">{{pedido.despacho_modificado_hora}}</span>
                    {% endif %}
                    </p>
                    <h5>Repartidor(es) elegido(s)</h5>
                    <ul class="list-group list-group-flush">
                        {% for r in repartidoresActivos %}
                        <li class="list-group-item">
                            <p>{{r.repartidor.first_name}} {{r.repartidor.last_name}}
                                Cod. Empleado {{r.repartidor.id}}
                            </p>
                        </li>
                        {% endfor %}
                    </ul>
                    {% endif %}
                </article>
            </section>
            <!-- Completación -->
            <section class="card mb-3">
                <article class="card-header text-center">
                    <h5 class="card-title">Resumen</h5>
                </article>
                <article class="card-body">
                    {% if pedido.estado.id < 5 %}
                        <h5>Este pedido no aún no se ha completado</h5>
                    {% else %}
                        <h5>Este pedido ya fue completado</h5>
                        <p>Hora de venta: {{pedido.fecha}}</p>
                        <p>Hora de finalizacion: {{pedido.completado_hora}}</p>
                        <p>{{ pedido.get_tiempo_pedido }}</p>
                    {% endif %}
                </article>
            </section>
        </section>
        <!-- Productos va aquí -->
        <aside class="col-md-6">
            <!-- Filtrar por bodegas si esta en empaquetacion -->
            {% if pedido.estado.id == 0 or pedido.estado.id == 1 %}
                <!-- Productos de bodega 1 -->
                {% if productos_bodega_1 %}
                <article class="card">
                    <section class="card-body">
                        <h5 class="card-title">Productos de bodega 1</h5>
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th scope="col">Producto</th>
                                    <th scope="col">Cantidad</th>
                                    <th scope="col">Tipo Cantidad</th>
                                    {% if pedido.estado_id == 1 %}
                                        <th scope="col">Acción</th>
                                    {% endif %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for p in productos_bodega_1 %}
                                    <tr id="p-{{p.producto_id}}" class="{% if pedido.estado_id == 1 or pedido.estado_id == 2 %}producto_listado{% endif %}">
                                        <td class="nombre_producto">
                                            {% if p.cantidad > 0 %}
                                                {{ p.producto.descripcion }}
                                            {% else %}
                                                <strike>{{ p.producto.descripcion }}</strike>
                                            {% endif %}
                                        </td>
                                        
                                        {% if user.tipo_usuario_id == 3 or isAdmin  %}
                                            {% if pedido.estado_id == 1 %}
                                                {% if p.cantidad > 0 %}
                                                    <td class="modificarCantidadTd text-center">
                                                        <input type="hidden" name="" value="{{p.producto_id}}">
                                                        <input type="number" name="" id="" value="{{ p.cantidad }}" class="cantidadProducto form-control" placeholder="Cantidad (obligatorio)">
                                                        <input type="text" name="" id="" value="{{p.paquete}}" placeholder="Paquete (Opcional)" class="paqueteProducto form-control strikeable_field my-2">
                                                        <input type="text" name="" id="" value="{{p.peso}}" placeholder="Peso (Opcional)" class="pesoProducto form-control strikeable_field">
                                                    </td>
                                                {% else %}
                                                    <td>
                                                        <strong>Producto agotado</strong>
                                                    </td>
                                                {% endif%}
                                                <td>
                                                    <select name="tipo_cantidad" id="" class="form-select tipoCantidadProducto">
                                                        {% for tipo in tipos_cantidad %}
                                                            <option value="{{tipo.id}}" {% if tipo.id == p.tipo_cantidad_id %} selected {% endif %}>{{tipo.description}}</option>
                                                        {% endfor %}
                                                    </select>
                                                </td>
                                                <td>   
                                                    {% if p.cantidad > 0 %}
                                                        <!-- trigger -->
                                                        <button type="button" class="btn btn-danger btn-sm me-1 mb-2 cart-handler" title="Indicar que este producto no tiene existencias" data-bs-toggle="modal" data-bs-target="#modalProductoAgotado-{{p.producto_id}}">
                                                            Producto agotado
                                                        </button>
                                                        <!-- modal -->
                                                        <section class="modal fade" id="modalProductoAgotado-{{p.producto_id}}" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
                                                            <article class="modal-dialog modal-dialog-centered">
                                                            <article class="modal-content">
                                                                <section class="modal-header">
                                                                <h5 class="modal-title">Marcar como agotado</h5>
                                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                                </section>
                                                                <section class="modal-body">
                                                                <p>Al hacer click en confirmar, usted confirma que {{p.producto.descripcion}} no tiene existencias en ninguna de las bodegas.</p>
                                                                <form action="" method="POST" class="modificarCantidad">
                                                                    {% csrf_token %}
                                                                    <input type="hidden" name="productoAgotado">
                                                                    <input type="hidden" name="producto_id" value="{{p.producto_id}}">
                                                                    <button type="submit" class="btn btn-danger mt-4 delete-item">Confirmar</button>                             
                                                                </form> 
                                                                </section>
                                                            </article>
                                                            </article>
                                                        </section>
                                                    {% else %}
                                                        <button type="button" class="btn btn-success btn-sm me-1 mb-2 cart-handler" title="Indicar que este producto no tiene existencias" data-bs-toggle="modal" data-bs-target="#modalProductoNoAgotado-{{p.producto_id}}">
                                                            Marcar como existente
                                                        </button>
                                                        <section class="modal fade" id="modalProductoNoAgotado-{{p.producto_id}}" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
                                                            <article class="modal-dialog modal-dialog-centered">
                                                            <article class="modal-content">
                                                                <section class="modal-header">
                                                                <h5 class="modal-title">Marcar como agotado</h5>
                                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                                </section>
                                                                <section class="modal-body">
                                                                <p>¿Encontraron más existencias de {{p.producto.descripcion}} ?</p>
                                                                <form action="" method="POST" id="modificarCantidad">
                                                                    {% csrf_token %}
                                                                    <input type="hidden" name="productoNoAgotado">
                                                                    <input type="hidden" name="producto_id" value="{{p.producto_id}}">
                                                                    <button type="submit" class="btn btn-success mt-4 delete-item">Confirmar</button>                             
                                                                </form> 
                                                                </section>
                                                            </article>
                                                            </article>
                                                        </section>
                                                    {% endif %}
                                                </td>
                                            {% else %}
                                                <td>{{ p.cantidad }}</td>
                                            {% endif %}
                                        {% else %}
                                            <td>{{ p.cantidad }}</td>
                                        {% endif %}
                                        {% if pedido.estado_id != 1 %}
                                            <td>{{p.tipo_cantidad}}</td>
                                        {% endif %}
                                    </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot>
                                <tr>
                                    {% if user.tipo_usuario_id == 3 or isAdmin %}
                                        {% if pedido.estado_id == 1 %}
                                            <td></td>
                                            <td class="text-center">
                                                <form action="" method="POST" id="modificarCantidad">
                                                    {% csrf_token %}
                                                    <input type="hidden" name="modificarCantidad">
                                                    <button type="submit" class="btnModificarCantidad btn btn-sm btn-warning text-white" >Guardar información</button>
                                                </form>
                                            </td>
                                        {% endif %}
                                    {% endif %}
                                </tr>
                                
                            </tfoot>
                        </table>
                    </section>

                </article>
                {% endif %}
                <!-- Productos de bodega 2 -->
                {% if productos_bodega_2 %}
                    <article class="card mt-4">
                        <section class="card-body">
                            <h5 class="card-title">Productos de bodega 2</h5>
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th scope="col">Producto</th>
                                        <th scope="col">Cantidad</th>
                                        <th scope="col">Tipo Cantidad</th>
                                        {% if pedido.estado_id == 1 %}
                                            <th scope="col">Acción</th>
                                        {% endif %}
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for p in productos_bodega_2 %}
                                        <tr id="p-{{p.producto_id}}" class="{% if pedido.estado_id == 1 or pedido.estado_id == 2 %}producto_listado{% endif %}">
                                            <td class="nombre_producto">
                                                {% if p.cantidad > 0 %}
                                                    {{ p.producto.descripcion }}
                                                {% else %}
                                                    <strike>{{ p.producto.descripcion }}</strike>
                                                {% endif %}
                                            </td>
                                            
                                            {% if user.tipo_usuario_id == 3 or isAdmin  %}
                                                {% if pedido.estado_id == 1 %}
                                                    {% if p.cantidad > 0 %}
                                                        <td class="modificarCantidadTd text-center">
                                                            <input type="hidden" name="" value="{{p.producto_id}}">
                                                            <input type="number" name="" id="" value="{{ p.cantidad }}" class="cantidadProducto form-control" placeholder="Cantidad (obligatorio)">
                                                            <input type="text" name="" id="" value="{{p.paquete}}" placeholder="Paquete (Opcional)" class="paqueteProducto form-control strikeable_field my-2">
                                                            <input type="text" name="" id="" value="{{p.peso}}" placeholder="Peso (Opcional)" class="pesoProducto form-control strikeable_field">
                                                        </td>
                                                    {% else %}
                                                        <td>
                                                            <strong>Producto agotado</strong>
                                                        </td>
                                                    {% endif%}
                                                    <td>
                                                        <select name="tipo_cantidad" id="" class="form-select tipoCantidadProducto">
                                                            {% for tipo in tipos_cantidad %}
                                                                <option value="{{tipo.id}}" {% if tipo.id == p.tipo_cantidad_id %} selected {% endif %}>{{tipo.description}}</option>
                                                            {% endfor %}
                                                        </select>
                                                    </td>
                                                    <td>   
                                                        {% if p.cantidad > 0 %}
                                                            <!-- trigger -->
                                                            <button type="button" class="btn btn-danger btn-sm me-1 mb-2 cart-handler" title="Indicar que este producto no tiene existencias" data-bs-toggle="modal" data-bs-target="#modalProductoAgotado-{{p.producto_id}}">
                                                                Producto agotado
                                                            </button>
                                                            <!-- modal -->
                                                            <section class="modal fade" id="modalProductoAgotado-{{p.producto_id}}" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
                                                                <article class="modal-dialog modal-dialog-centered">
                                                                <article class="modal-content">
                                                                    <section class="modal-header">
                                                                    <h5 class="modal-title">Marcar como agotado</h5>
                                                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                                    </section>
                                                                    <section class="modal-body">
                                                                    <p>Al hacer click en confirmar, usted confirma que {{p.producto.descripcion}} no tiene existencias en ninguna de las bodegas.</p>
                                                                    <form action="" method="POST" class="modificarCantidad">
                                                                        {% csrf_token %}
                                                                        <input type="hidden" name="productoAgotado">
                                                                        <input type="hidden" name="producto_id" value="{{p.producto_id}}">
                                                                        <button type="submit" class="btn btn-danger mt-4 delete-item">Confirmar</button>                             
                                                                    </form> 
                                                                    </section>
                                                                </article>
                                                                </article>
                                                            </section>
                                                        {% else %}
                                                            <button type="button" class="btn btn-success btn-sm me-1 mb-2 cart-handler" title="Indicar que este producto no tiene existencias" data-bs-toggle="modal" data-bs-target="#modalProductoNoAgotado-{{p.producto_id}}">
                                                                Marcar como existente
                                                            </button>
                                                            <section class="modal fade" id="modalProductoNoAgotado-{{p.producto_id}}" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
                                                                <article class="modal-dialog modal-dialog-centered">
                                                                <article class="modal-content">
                                                                    <section class="modal-header">
                                                                    <h5 class="modal-title">Marcar como agotado</h5>
                                                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                                    </section>
                                                                    <section class="modal-body">
                                                                    <p>¿Encontraron más existencias de {{p.producto.descripcion}} ?</p>
                                                                    <form action="" method="POST" id="modificarCantidad">
                                                                        {% csrf_token %}
                                                                        <input type="hidden" name="productoNoAgotado">
                                                                        <input type="hidden" name="producto_id" value="{{p.producto_id}}">
                                                                        <button type="submit" class="btn btn-success mt-4 delete-item">Confirmar</button>                             
                                                                    </form> 
                                                                    </section>
                                                                </article>
                                                                </article>
                                                            </section>
                                                        {% endif %}
                                                    </td>
                                                {% else %}
                                                    <td>{{ p.cantidad }}</td>
                                                {% endif %}
                                            {% else %}
                                                <td>{{ p.cantidad }}</td>
                                            {% endif %}
                                            {% if pedido.estado_id != 1 %}
                                                <td>{{p.tipo_cantidad}}</td>
                                            {% endif %}
                                        </tr>
                                    {% endfor %}
                                </tbody>
                                <tfoot>
                                    <tr>
                                        {% if user.tipo_usuario_id == 3 or isAdmin %}
                                            {% if pedido.estado_id == 1 %}
                                                <td></td>
                                                <td class="text-center">
                                                    <form action="" method="POST" id="modificarCantidad">
                                                        {% csrf_token %}
                                                        <input type="hidden" name="modificarCantidad">
                                                        <button type="submit" class="btnModificarCantidad btn btn-sm btn-warning text-white" >Guardar información</button>
                                                    </form>
                                                </td>
                                            {% endif %}
                                        {% endif %}
                                    </tr>
                                    
                                </tfoot>
                            </table>
                        </section>

                    </article>
                {% endif %}
            {% else %}
            <!-- Productos en general -->
                <article class="card">
                    <section class="card-body">
                        <h5 class="card-title">Productos en el pedido:</h5>
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th scope="col">Producto</th>
                                    <th scope="col">Cantidad</th>
                                    <th scope="col">Tipo Cantidad</th>
                                    <th scope="col">Peso</th>
                                    <th scope="col">Paquete</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for p in productos %}
                                    <tr id="p-{{p.producto_id}}" class="{% if pedido.estado_id == 2 %}producto_listado{% endif %}">
                                        <td class="nombre_producto">
                                            {{ p.producto.descripcion }}
                                        </td>
                                        <td>{{ p.cantidad }}</td>
                                        <td>{{p.tipo_cantidad}}</td>
                                        <td>{{ p.peso }}</td>
                                        <td>{{ p.paquete }}</td>
                                            
                                    </tr>
                                {% endfor %}
                            </tbody>

                        </table>
                    </section>
                </article>
            {% endif %}
            <!-- Notas del pedido -->
            {% if user.tipo_usuario_id == 3 or isAdmin %}
                {% if pedido.estado_id == 1  %} 
                    <section class="card my-4">
                        <article class="card-body">
                            <h5 class="card-title">Nota al pedido. No es obligatorio.</h5>
                            <form action="" method="post" id="notaEmpacador">
                                {% csrf_token %}
                                <input type="hidden" name="notaEmpacador" id="notaEmpacador">
                                <textarea name="notaPedido" id="" cols="20" rows="2" class="form-control mb-2" placeholder="Escriba su nota aquí">{% if pedido.notaEmpacador and pedido.notaEmpacador is not None %} {{pedido.notaEmpacador}} {% endif %}</textarea>
                                <button type="submit" class="btn btn-success">Guardar nota</button>
                            </form>
                        </article>
                    </section>
                {% endif %}
            {% endif %}
        </aside>
    </section>
    {% else %}
        <section class="alert alert-danger" role="alert">{{msg}}</section>
    {% endif %}
</main>
{% endblock %}